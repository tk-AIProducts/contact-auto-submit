# apotto 要件

## 1. 全体像とアーキテクチャ
- プロダクト名は **apotto**。画面は「AIカスタム文面生成」と「管理ダッシュボード」の2構成に統一する。
- Supabase（spabase）を認証・DB・Storage・Queue として採用し、Next.js (App Router) は UI / API を担当する。
- PDF は Supabase Storage コンテナで管理し、閲覧イベントや PDF 反応データは Supabase DB に保存する。
- OpenAI へのプロンプトは自社情報 (`sender.*`) と相手企業情報 (`recipient.*`) を明確に分離した JSON で投げ、欠損値は `◯◯◯` を自動補完する。

---

## 2. 画面A: AIカスタム文面生成

### 2.1 入力UI
- セクションを「自社情報」「相手企業情報」「資料添付」「生成結果」に分割し、必須/任意を明示する。
- 自社情報は担当者名・部署・役職・会社名・メール・電話などをまとめて入力し、各生成文に共通適用。
- 相手企業カードでは会社名、担当者名、部署、役職、フォームURL（必須）、メール、備考を編集できる。
- フォーム必須項目は **ホームページ（問い合わせフォーム）URLのみ**。未入力時は保存/生成不可。他フィールドは未入力なら `◯◯◯` を挿入。
- UI 上で「こちらの会社情報」「送信先の担当者情報」を色分けし、混在しないようラベル・説明文・ツールチップを配置する。

### 2.2 Excel / CSV インポート
- `.xlsx / .xls / .csv` をドラッグ&ドロップまたはファイル選択で受け付ける。1 行目はヘッダー扱い、**最大 100 社** まで読み込み。
- 列仕様（左から順に 5 列、5列目のみ必須）:
  1. 相手担当者名
  2. 相手部署名
  3. 相手役職名
  4. 相手メールアドレス
  5. 相手企業のホームページ（問い合わせフォーム）URL
- アップロード完了後は自動的に AI 生成キューが上から順に起動する。読み込まれた行は即カード化し、右上チェックボックスを **初期 ON** で描画。
- 列欠損・101 行目以降・読み取り失敗時はエリア下に詳細なエラーを表示し、該当レコードはカード化しない。

### 2.3 生成キューとカード操作
- `useGenerationQueue`（新規フック）でエクセル読み込みイベントを監視し、Supabase Queue にジョブを投入する。進行状況はカードのステータス/スピナーで表示。
- カード右上のチェックボックスで送信対象を切り替える。ON のカードのみ一括送信に含め、OFF は完全除外。
- 生成文はカード内プレビュー＋モーダルで編集。送信者/相手のタグ付き構造を保ちつつ、`◯◯◯` などの補完語も上書き可能。
- 送信不可（URL 無効など）のカードはエラー理由を表示し、自動的に OFF へ切り替える。

### 2.4 プロンプト/生成品質
- `src/lib/openaiClient.ts` のプロンプトテンプレートを Sender / Recipient / Product Context / Target Site Summary / Attached PDFs で区切る。
- 文字数制限・段落構成（挨拶→背景→提案→CTA）をテンプレート側で指定し、中途半端なテキストを防ぐポストプロセス（句点締め/改行調整）を実装。
- 生成ログには sender と recipient を個別フィールドで保存し、UI も同じ構造で表示する。

### 2.5 PDF 添付とトラッキング URL
- Supabase Storage に登録済み PDF を一覧表示し、文面ごとに 1 つ以上選択可能。選択した PDF ごとにユニークなトラッキング URL を生成する。
- URL をクリックすると apotto の PDF 閲覧ページ（`/pdf/[token]`）へ遷移し、閲覧前にメールアドレス入力を要求する。
- 生成した URL と PDF/企業カード ID を Supabase DB に保存し、後続の閲覧ログと紐付ける。

### 2.6 自動送信とチェックボックス制御
- フォーム送信ロジックは既存 Playwright ワーカーを流用し、AI カスタム画面から直接ジョブ登録する。送信対象はチェックボックス ON のカードのみ。
- 一括送信ボタン押下時、ON のカード順にジョブを投入し、失敗時はエラーログ/再送ボタンを表示。OFF のカードはジョブ投入されない。

---

## 3. 画面B: 管理ダッシュボード (`/dashboard`)

### 3.1 KPI とグラフ
- Supabase DB の閲覧ログを集計し、以下をカード型 KPI として表示:
  - 総閲覧数 / ユニーク閲覧者
  - PDF 別閲覧回数ランキング
  - 相手企業別の反応率
  - 直近 7 日 / 30 日の閲覧推移
- Recharts などで棒グラフ/折れ線/ヒートマップを表示し、非技術者でも理解できるラベル・ツールチップ・凡例を付ける。

### 3.2 フィルタ・テーブル
- 期間（7日/30日/カスタム）、PDF、企業、担当者でフィルタリング可能にする。
- 閲覧ログテーブルでは `viewer_email`, `company_name`, `pdf_title`, `viewed_at`, `view_count` を表示し、ソート/検索/ページネーションを提供。
- チェックボックス ON の企業だけを抽出するフィルタも用意し、送信対象の成果を追いやすくする。

### 3.3 PDF 管理
- PDF のアップロード/削除/リネームは AI 画面と共通のコンポーネントを利用。Storage との整合性とダッシュボードの統計を同期させる。
- 各 PDF ごとにユニークトークンの発行数・閲覧数・クリック率を一覧表示。

---

## 4. PDF 閲覧ページ (`/pdf/[token]`)
- トラッキング URL が参照されたら、メールアドレス入力フォームを表示し、送信後に PDF を埋め込む。
- メールアドレスと紐づく企業カード・PDF・閲覧時刻を Supabase に保存し、ダッシュボードへリアルタイム（SSE or ポーリング）で反映。
- 未入力/無効トークン時は閲覧させず、エラーメッセージを表示。トークンの有効期限や失効操作も DB で管理する。

---

## 5. Supabase リソース
- テーブル例:
  - `company_cards`（sender 情報と recipient 情報を分離して保存）
  - `ai_generations`（生成結果・トークン・ジョブ状態）
  - `pdf_files`（Storage パス・サイズ・アップロード者）
  - `pdf_tokens`（トークン・pdf_id・company_card_id・有効期限）
  - `pdf_views`（token_id・viewer_email・viewed_at・user_agent）
- 必要な RLS / サービスロール権限を整理し、AI 画面/ダッシュボードから安全に読み書きできるようにする。

---

## 6. 検証観点
- Excel で 101 行以上や 5 列目欠損時に読み込みが拒否される。
- Excel 取込完了直後に AI 生成が順次開始し、カードにステータスが表示される。
- 生成テキストで sender / recipient が混在しないこと、`◯◯◯` の補完が必要箇所みに入ること。
- PDF トラッキング URL をクリックした閲覧だけが記録され、ダッシュボードで即時確認できる。
- チェックボックス OFF の企業が誤って送信されないこと。
- 管理ダッシュボードのフィルタ・グラフが想定通りに反応し、非技術者にも理解しやすい UI になっていること。

